<html> 
<head> 
    <title>VOEIS Uploader</title> 
    <script type="text/javascript" src="AIRAliases.js"></script> 
    <script type="text/javascript" src="jquery-1.7.2-min.js"></script> 
    <script type="text/javascript" src="jquery-mobile-1.1.0-min.js"></script> 
    <link rel="stylesheet" href="jquery-mobile-1.1.0-min.css"/>
    <script type="text/javascript"> 

        //var base_url = "https://voeis.msu.montana.edu";
        var base_url = "http://localhost:3000";
        var api_key= "";
        var db = null;
        var stmt = null;
        //var NONE = −1;
        var CREATE_SCHEMA = 0;
        var INSERT_DATA = 1;
        var DELETE_TASK = 2;
        var state = -1;
        
        function fetch_api_key(){
         //alert($('#login').val()+":"+$('#password').val()); 
         $.get(base_url+"/user_session/get_api_key.json?user_session[login]="+$('#login').val()+"&user_session[password]="+$('#password').val(),
             function(data){
               alert("Data Loaded: " + data['api_key']);
               api_key = data['api_key'];
               stmt.text = 'INSERT INTO api_key ("api_key") VALUES (' +'\''+api_key+'\''+')';
               stmt.execute();
               $('#login_div').hide();
               $('#add_project_div').show();
             });
        }

        function doDbOpen( event )
        {
           stmt = new air.SQLStatement();
           stmt.addEventListener( air.SQLErrorEvent.ERROR, 
                doStmtError );
           stmt.addEventListener( air.SQLEvent.RESULT, doStmtResult );
              stmt.sqlConnection = db;
              stmt.text = 'CREATE TABLE IF NOT EXISTS uploads ( ' +
                                  'id INTEGER PRIMARY KEY AUTOINCREMENT, ' +
                                  'project_id TEXT, ' +
                                  'site_id INTEGER, ' +
                                  'template_id INTEGER, ' + 
                                  'time INTEGER, ' +
                                  'file Text)';
              stmt.execute();
              stmt.text = 'CREATE TABLE IF NOT EXISTS api_key ( ' +
                                  'api_key Text)';
              stmt.execute();
         }
             
         function doLoad()
         {
            var file = air.File.applicationDirectory.resolvePath(
         'voeis_upload.db' );
            db = new air.SQLConnection();
            db.addEventListener( air.SQLEvent.OPEN, doDbOpen );
            db.open( file, air.SQLMode.CREATE );
         }
         function doStmtError( event )
         {
            alert( 'There has been a problem executing a statement:\n' + event.error.message );
         }
         function doSave()
         {
             var project_id = $('#project_id' ).val();
             var site_id = $('#site_id' ).val();
             var template_id = $('#template_id').val();
             var time = $('#time').val();
             var file = $('#file').val();
             stmt.text = 'INSERT INTO uploads ("project_id","site_id","template_id","time","file") VALUES ( ' +
                                 '\'' + project_id + '\', '+ site_id + ', ' + template_id + ', ' + 
                                 time + ', ' +
                                 '\'' + file + '\')';
             state = INSERT_DATA;
             stmt.execute();
         }
         function doStmtResult( event )
         {
             switch( state )
             {
                  case CREATE_SCHEMA:
                       alert( 'The database table has been created.' );
                       state = -1;
                       break;
                  case INSERT_DATA:
                       state = -1;
                       $('#project_id' ).val("");
                       $('#site_id' ).val("");
                       e_id = $('#template_id').val("");
                       $('#time').val("");
                       $('#file').val("");
                       getProjectTasks();
                       alert( 'A new record has been stored.' );
                       break;
                  case DELETE_TASK: 
                       state = -1;
                       getProjectTasks(); 
                       alert("Task Deleted");
                       break;
             }
         }
        
        function getProjectTasks(){
          var results = null;
          stmt.text = 'SELECT * FROM uploads'
          stmt.execute();
          results = stmt.getResult();
          $('#project_tasks_div').empty();
          $('#project_tasks_div').html("No Upload Tasks Exist.");
          if( results.data != null )
              {
                   $('#project_tasks_div').empty();
                   for( var c = 0; c < results.data.length; c++ )
                   {
                        $('#project_tasks_div').html($('#project_tasks_div').html() +'<p>Project ID: '+ results.data[c].project_id +
                          '<br/>Filename: '+results.data[c].file+'<button onClick="deleteProjectTask('+results.data[c].id.toString()+')">Delete Upload Task</button></p>')
                   }
              }
        }
        
        function deleteProjectTask(task_id){
          stmt.text = 'DELETE FROM uploads WHERE id=' + task_id;
          state = DELETE_TASK;
          stmt.execute();
        }
        
        function uploadFiles(){
          var results = null;
          stmt.text = 'SELECT * FROM uploads'
          stmt.execute();
          results = stmt.getResult();
          alert(results.data);
          var name_results = null;
          stmt.text = 'SELECT * FROM api_key'
          stmt.execute();
          name_results = stmt.getResult();
          alert(name_results.data[0].api_key);
          
          if( results.data != null )
          {
            for( var c = 0; c < results.data.length; c++ )
             {
               //var variables = new.air.URLVariables();
               //variables.api_key = name_results.data[0].api_key;
               params = 'api_key='+name_results.data[0].api_key+'&data_template_id='+results.data[c].template_id+'&site_id='+results.data[c].site_id;
               var url = base_url + '/projects/' + results.data[c].project_id + '/apivs/upload_data.json?';  
               var tmpRequest = new air.URLRequest(url);
               var datafile = new air.File(results.data[c].file);
               //tmpRequest = new air.URLRequest(base_url + results.data[c].project_id + '/apivs/upload_data.json?');
               tmpRequest.method = air.URLRequestMethod.POST;
               tmpRequest.contentType = 'multipart/form-data';   
               tmpRequest.data = params;
               //air.sendToURL(tmpRequest);
               //alert(url);
               // attach events for displaying progress bar and upload complete
               //datafile.addEventListener(air.ProgressEvent.PROGRESS, callback_for_upload_progress);
               datafile.addEventListener(air.DataEvent.UPLOAD_COMPLETE_DATA, callback_for_upload_finish); 

               // doing upload request to server
               datafile.upload(tmpRequest, 'datafile', false);
               //file.addEventListener(air.Event.COMPLETE, uploadComplete);
               //file.upload(request, file);    
             }
          }  
        }
        function callback_for_upload_progress(event) { 
            var loaded = event.bytesLoaded; 
            var total = event.bytesTotal; 
            var pct = Math.ceil( ( loaded / total ) * 100 ); 
            air.trace('Uploaded ' + pct.toString() + '%');
        }

        function callback_for_upload_finish(event) {
            //Console.log('File upload complete');
            //air.trace(event.data); // output of server response to AIR dev console
            alert(event.data); 
        }
        
        function getUserProjects(){
          var name_results = null;
          stmt.text = 'SELECT * FROM api_key'
          stmt.execute();
          name_results = stmt.getResult();
          $.get(base_url+"/projects/get_user_projects.json?api_key="+name_results.data[0].api_key,
               function(data){
                 if (data['errors'] == null){
                   for( var c = 0; c < data.length; c++ )
                   {
                     $('#project_id')
                        .append($("<option></option>")
                        .attr("value",data[c]['id'])
                        .text(data[c]['name']));
                   }
                 }
                 else{
                   alert(data['errors']);
                 }
               });
        }
        function getProjectSites(){
          var name_results = null;
          stmt.text = 'SELECT * FROM api_key'
          stmt.execute();
          name_results = stmt.getResult();
          $.get(base_url+"/projects/"+$('#project_id').attr("value")+"/sites.json?api_key="+name_results.data[0].api_key,
               function(data){
                 if (data['errors'] == null){
                   $('#site_id').empty();
                   for( var c = 0; c < data.length; c++ )
                   {
                     $('#site_id')
                        .append($("<option></option>")
                        .attr("value",data[c]['id'])
                        .text(data[c]['name']));
                   }
                 }
                 else{
                   alert(data['errors']);
                 }
               });
        }
        function getProjectDataTemplates(){
          var name_results = null;
          stmt.text = 'SELECT * FROM api_key'
          stmt.execute();
          name_results = stmt.getResult();
          $.get(base_url+"/projects/"+$('#project_id').attr("value")+"/data_streams.json?api_key="+name_results.data[0].api_key,
               function(data){
                 if (data['errors'] == null){
                   $('#template_id').empty();
                   for( var c = 0; c < data.length; c++ )
                   {
                     $('#template_id')
                        .append($("<option></option>")
                        .attr("value",data[c]['id'])
                        .text(data[c]['name']));
                   }
                 }
                 else{
                   alert(data['errors']);
                 }
               });
        }
    </script> 
</head> 
<body  onload="$('#add_project_div').hide();$('#project_tasks_div').hide();doLoad();getProjectTasks();" style="padding-left:5px;"> 
    <a href="" onClick="$('#login_div').toggle();">Set User</a> |
    <a href="" onClick="getUserProjects();$('#add_project_div').toggle();">Add Upload Task</a> |
    <a href="" onClick="$('#project_tasks_div').toggle();">View Upload Task</a>
    <h1>VOEIS Uploader</h1> 
    <div id="login_div">
      <p>
        VOEIS Login:
        <input type="text" name="login" id="login"/>
      </p>  
      <p>
        Password
        <input type="password" name="password" id="password"/>
      </p>
      <button onClick="fetch_api_key();">Submit</button>
    </div>
  <div id="add_project_div">
    <p>
      Project ID:
      <select id="project_id" name="project_id" onchange="getProjectSites();getProjectDataTemplates();"></select>
    </p>  
    <p>
      Site ID:
      <select id="site_id" name="site_id"></select>
    </p>
    <p>
      Template ID:
      <select id="template_id" name="template_id"></select>
    </p>  
    <p>
      File:
      <input type="file" name="file" id="file"/>
    </p>  
    <p>
      Time interval in minutes:(1440 = once a day):
      <input type="text" name="time" id="time"/>
    </p>
    <button onClick="doSave();">Submit</button>
  </div>
  <div id="project_tasks_div">
    Project Stuff in here
  </div>
  <button onClick="uploadFiles();">Start Uploads</button>
</body> 
</html>